<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WaitRoom â€“ åœç•™ä¸€å°æ™‚æ‹¿æ——</title>
  <style>
    :root{--bg:#0f1115;--fg:#e5e7eb;--muted:#9ca3af}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto}
    .wrap{position:fixed;inset:0;display:grid;place-items:center}
    .bigbtn{position:absolute;inset:0;border:none;background:transparent;cursor:pointer}
    .panel{z-index:1;display:flex;flex-direction:column;gap:.75rem;align-items:center;text-align:center;padding:2rem;max-width:720px}
    .title{font-size:clamp(28px,4vw,40px);font-weight:800}
    .kpis{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center}
    .kpi{padding:1rem 1.25rem;border:1px solid #1f2937;border-radius:16px;background:#0b0d12}
    .kpi .v{font-variant-numeric:tabular-nums;font-size:1.25rem}
    .sub{color:var(--muted);font-size:.9rem}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center}
    .btn{padding:.6rem 1rem;border-radius:12px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .hint{font-size:.95rem;color:#a7f3d0}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;border:1px dashed #334155;color:#94a3b8}

    /* ç‰¹æ®Šé é¢ï¼ˆæ¨¡æ…‹ï¼‰ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:1rem}
    .modal.show{display:flex}
    .card{background:#0b0d12;border:1px solid #1f2937;border-radius:18px;max-width:560px;width:100%;padding:1.25rem}
    .card h3{margin:.25rem 0 .5rem 0;font-size:1.15rem}
    .card p{color:#d1d5db;line-height:1.6}

    /* é—œé–‰ç•«é¢ */
    .closed{position:fixed;inset:0;display:grid;place-items:center;background:#0a0c10}
    .closed .box{border:1px dashed #374151;border-radius:18px;padding:2rem;max-width:560px;text-align:center}
    .closed h2{margin:0 0 .5rem 0}

    /* flag ç•«é¢ */
    .flagwrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.72)}
    .flagwrap.show{display:flex}
    .flagcard{background:#001b1b;border:1px solid #0e7490;border-radius:20px;padding:1.5rem;max-width:680px;width:100%}
    .flagcard h2{margin:0 0 .5rem 0}
    code{background:#111827;border:1px solid #1f2937;padding:.25rem .4rem;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <button class="bigbtn" id="bigbtn" aria-label="ç­‰å¾…å³å¯ç²å¾—æ——å¹Ÿ"></button>
    <div class="panel">
      <div class="title">ç­‰å¾…ä¸€å°æ™‚ï¼Œç²å¾—æ——å¹Ÿ ğŸ³ï¸</div>
      <div class="kpis">
        <div class="kpi"><div class="sub">å·²ç­‰å¾…</div><div class="v" id="elapsed">00:00:00</div></div>
        <div class="kpi"><div class="sub">è·é›¢è‡ªå‹•é—œé–‰ï¼ˆ30 åˆ†ï¼‰</div><div class="v" id="toClose">30:00</div></div>
        <div class="kpi"><div class="sub">è·é›¢å¯é ˜æ——ï¼ˆ60 åˆ†ï¼‰</div><div class="v" id="toFlag">60:00</div></div>
        <div class="kpi"><div class="sub">é»æ“Šæ¬¡æ•¸ï¼ˆâ‰¤3ï¼‰</div><div class="v" id="clicks">0</div></div>
      </div>

      <div class="row">
        <!-- ä¸€éµé‡ç½®ï¼ˆä¸€èˆ¬ç•«é¢ä¹Ÿèƒ½æŒ‰ï¼‰ -->
        <button class="btn" id="resetBtn" title="æ¸…é™¤ wr_start_at / wr_clicks / wr_closed ä¸¦é‡æ•´">é‡ç½®æŒ‘æˆ°</button>
      </div>

      <div class="hint">æç¤ºï¼šä»»æ„é»æ“Šéƒ½æœƒè·³å‡ºã€Œç‰¹æ®Šé é¢ã€ã€‚ä½†é»å¤ªå¤šæœƒé—œé–€å–”ã€‚</div>
      <div class="sub">ä½ å¯ä»¥å¾ <span class="pill">é–‹ç™¼äººå“¡å·¥å…·</span> è§€å¯Ÿç­‰å¾…é‚è¼¯ï¼›æˆ–ç›´æ¥æ‰¾ <code>/flag.txt</code>ã€‚</div>
    </div>
  </div>

  <!-- ç‰¹æ®Šé é¢ï¼ˆç·šç´¢ï¼‰ -->
  <div class="modal" id="modal">
    <div class="card">
      <h3>ç‰¹æ®Šé é¢ï¼ˆç·šç´¢ï¼‰</h3>
      <p id="clueText">â€¦â€¦</p>
      <div class="row">
        <button class="btn" id="closeModal">çŸ¥é“äº†</button>
        <button class="btn" id="openDevtools">æ€éº¼æ‰¾é‚è¼¯ï¼Ÿ</button>
      </div>
    </div>
  </div>

  <!-- flag ç•«é¢ -->
  <div class="flagwrap" id="flagwrap">
    <div class="flagcard">
      <h2>æ­å–œä½ ï¼Œè€å¿ƒé€šé—œï¼</h2>
      <p>ä»¥ä¸‹ç‚ºä½ çš„æ——å¹Ÿï¼š</p>
      <p><code id="flagText">loadingâ€¦</code></p>
      <p class="sub">ï¼ˆåŒæ™‚ä¹Ÿå¯æ–¼ <code>/flag.txt</code> ç›´æ¥å–å¾—ã€‚ï¼‰</p>
      <div class="row"><button class="btn" onclick="location.reload()">é‡æ–°é–‹å§‹</button></div>
    </div>
  </div>

  <script>
    // === ç­‰å¾…æ§åˆ¶ï¼ˆå…¬é–‹åœ¨å…¨åŸŸï¼Œä¾› DevTools æŸ¥çœ‹ï¼‰ ===
    window.__waitControls = {
      START_KEY: 'wr_start_at',
      CLICK_KEY: 'wr_clicks',
      CLOSED_KEY: 'wr_closed',
      FLAG_READY_SECS: 60 * 60,   // 1 å°æ™‚
      AUTO_CLOSE_SECS: 30 * 60,   // 30 åˆ†é˜
      MAX_CLICKS: 3
    };
    const S = window.__waitControls;

    // å°å·¥å…·
    const $ = s => document.querySelector(s);
    const now = () => Math.floor(Date.now()/1000);
    const fmtHMS = s => {
      s = Math.max(0, Math.floor(s));
      const h=String(Math.floor(s/3600)).padStart(2,'0');
      const m=String(Math.floor((s%3600)/60)).padStart(2,'0');
      const sec=String(s%60).padStart(2,'0');
      return `${h}:${m}:${sec}`;
    };
    const fmtMS = s => {
      s = Math.max(0, Math.floor(s));
      return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    };

    // åˆå§‹åŒ– LocalStorage
    if(!localStorage.getItem(S.START_KEY)) localStorage.setItem(S.START_KEY, String(now()));
    if(!localStorage.getItem(S.CLICK_KEY)) localStorage.setItem(S.CLICK_KEY, '0');

    // ä¸€éµé‡ç½®ï¼ˆä¸€èˆ¬ç•«é¢ï¼‰
    $('#resetBtn').addEventListener('click', () => {
      localStorage.removeItem(S.START_KEY);
      localStorage.removeItem(S.CLICK_KEY);
      localStorage.removeItem(S.CLOSED_KEY);
      location.reload();
    });

    // é—œé–‰ç•«é¢
    const isClosed = () => localStorage.getItem(S.CLOSED_KEY)==='1';
    const setClosed = () => { localStorage.setItem(S.CLOSED_KEY,'1'); renderClosed(); };

    function renderClosed(){
      document.body.innerHTML = `
        <div class="closed">
          <div class="box">
            <h2>Web å·²è‡ªå‹•é—œé–‰</h2>
            <p class="sub">åŸå› ï¼šè¶…é 30 åˆ†é˜æˆ–é»æ“Šè¶…é 3 æ¬¡ã€‚</p>
            <p class="sub">å¯æŒ‰ä¸‹æ–¹æŒ‰éˆ•æ¸…ç©º LocalStorage å¾Œé‡è©¦ã€‚</p>
            <div style="margin-top:1rem;">
              <button class="btn" onclick="
                localStorage.removeItem('wr_start_at');
                localStorage.removeItem('wr_clicks');
                localStorage.removeItem('wr_closed');
                location.reload();
              ">é‡ç½®æŒ‘æˆ°</button>
            </div>
          </div>
        </div>`;
    }

    if(isClosed()){ renderClosed(); }
    else { boot(); }

    function boot(){
      const startAt = Number(localStorage.getItem(S.START_KEY) || now());
      const modal = $('#modal');
      const closeModal = $('#closeModal');
      const openDevtools = $('#openDevtools');

      let clicks = Number(localStorage.getItem(S.CLICK_KEY) || 0);
      let closed = false;

      const clues = [
        'æç¤º 1ï¼šæ§åˆ¶å¸¸æ•¸å…¬é–‹åœ¨ window.__waitControlsã€‚',
        'æç¤º 2ï¼šLocalStorage çš„ wr_start_at / wr_clicks / wr_closedã€‚',
        'æç¤º 3ï¼š/flag.txt å¯èƒ½æ˜¯ä½ æƒ³æ‰¾çš„æª”æ¡ˆã€‚',
        'æç¤º 4ï¼šè¶…é 30 åˆ†é˜æˆ–é»æ»¿ 3 æ¬¡ï¼Œå°±æœƒè¢«é—œé–€ã€‚',
        'æç¤º 5ï¼šåœç•™æ»¿ 60 åˆ†é˜æœƒæ‰“é–‹æ——å¹Ÿç•«é¢ã€‚'
      ];

      function showClue(){
        $('#clueText').textContent = clues[Math.floor(Math.random()*clues.length)];
        modal.classList.add('show');
      }

      function updateKPI(){
        const t = now();
        const el = t - startAt;
        const toClose = S.AUTO_CLOSE_SECS - el;
        const toFlag  = S.FLAG_READY_SECS - el;
        $('#elapsed').textContent = fmtHMS(el);
        $('#toClose').textContent = fmtMS(toClose);
        $('#toFlag').textContent  = fmtMS(toFlag);
        $('#clicks').textContent  = String(clicks);

        if(el >= S.AUTO_CLOSE_SECS || clicks > S.MAX_CLICKS){ closed = true; setClosed(); return; }
        if(el >= S.FLAG_READY_SECS){ revealFlag(); }
      }
      const ticker = setInterval(updateKPI, 1000); updateKPI();

      // ä»»æ„é»æ“Š â†’ å½ˆç·šç´¢ï¼›>3 æ¬¡å‰‡é—œé–‰
      document.addEventListener('click', e => {
        if(closed) return;
        clicks++;
        localStorage.setItem(S.CLICK_KEY, String(clicks));
        showClue();
        if(clicks > S.MAX_CLICKS) setClosed();
      });

      closeModal.addEventListener('click', ()=> modal.classList.remove('show'));
      openDevtools.addEventListener('click', ()=> {
        modal.classList.remove('show');
        console.log('%cè§€å¯Ÿ window.__waitControls', 'color:#22d3ee');
        console.log(window.__waitControls);
      });
    }

    async function revealFlag(){
      const fw = document.querySelector('#flagwrap');
      const flagText = document.querySelector('#flagText');
      if(fw.classList.contains('show')) return;
      try{
        // åŠ æ™‚é–“æˆ³é¿å…å¿«å–
        const res = await fetch('/flag.txt?t=' + Date.now(), { cache: 'no-store' });
        const txt = (await res.text()).trim();
        flagText.textContent = txt || '(flag è¼‰å…¥å¤±æ•—)';
      }catch{ flagText.textContent = '(flag è¼‰å…¥å¤±æ•—)'; }
      fw.classList.add('show');
    }

    /* å‡æ——ï¼ˆæ“¾äº‚ç”¨ï¼‰ï¼šbase64 RkxBR3s2MHNfczBfTE9OR30= -> FLAG{60s_s0_LONG} */
  </script>
</body>
</html>
