<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WaitRoom</title>
  <style>
    :root{--bg:#0f1115;--panel:#0b0d12;--border:#1f2937;--fg:#e5e7eb;--muted:#9ca3af;--accent:#60a5fa;--danger:#ef4444;--ok:#22c55e}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto}
    .wrap{position:fixed;inset:0;display:grid;place-items:center}
    .bigbtn{position:absolute;inset:0;border:none;background:transparent;cursor:pointer}
    .panel{z-index:1;display:flex;flex-direction:column;gap:1rem;align-items:center;text-align:center;padding:2rem;max-width:920px;width:100%}
    .title{font-size:clamp(28px,4vw,44px);font-weight:800;letter-spacing:.02em}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:1rem;width:100%}
    @media (max-width:820px){.kpis{grid-template-columns:repeat(2,minmax(160px,1fr))}}
    .kpi{padding:1rem 1.25rem;border:1px solid var(--border);border-radius:16px;background:var(--panel)}
    .kpi .label{color:var(--muted);font-size:.9rem;margin-bottom:.25rem}
    .kpi .value{font-variant-numeric:tabular-nums;letter-spacing:.02em;font-size:1.35rem}
    .bar{margin-top:.5rem;height:6px;background:#0a0c10;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#34d399)}
    .bar.danger>i{background:linear-gradient(90deg,var(--danger),#f59e0b)}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center}
    .btn{padding:.6rem 1rem;border-radius:12px;border:1px solid var(--border);background:#0f172a;color:#e2e8f0;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.copy.ok{border-color:#14532d;background:#14532d}
    .hint{color:var(--muted);font-size:.9rem}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:1rem}
    .modal.show{display:flex}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;max-width:680px;width:100%;padding:1.25rem}
    .card h3{margin:.2rem 0 0.5rem 0}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b1220;border:1px solid var(--border);padding:.75rem;border-radius:10px;overflow:auto;font-size:.9rem;text-align:left}
    .code kbd{background:#111827;border:1px solid var(--border);padding:.08rem .35rem;border-radius:6px}

    .closed{position:fixed;inset:0;display:none;place-items:center;background:#0a0c10}
    .closed.show{display:grid}
    .closed .box{border:1px dashed var(--border);border-radius:18px;padding:2rem;max-width:620px;text-align:center;background:var(--panel)}

    .flagwrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.72)}
    .flagwrap.show{display:flex}
    .flagcard{background:#001b1b;border:1px solid #0e7490;border-radius:20px;padding:1.5rem;max-width:680px;width:100%}
    code{background:#111827;border:1px solid var(--border);padding:.25rem .4rem;border-radius:6px}
    .danger{color:var(--danger)}
    .ok{color:var(--ok)}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <!-- 只對這個「整頁大按鈕」計次 -->
    <button class="bigbtn" id="bigbtn" aria-label="等待即可獲得旗幟"></button>

    <div class="panel">
      <div class="title">等待一小時，伺服器驗證 🏳️</div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">已等待</div>
          <div class="value" id="elapsed">--:--:--</div>
        </div>

        <div class="kpi">
          <div class="label">距離自動關閉</div>
          <div class="value" id="toClose">--:--</div>
          <div class="bar danger"><i id="barClose" style="width:0%"></i></div>
        </div>

        <div class="kpi">
          <div class="label">距離可領旗</div>
          <div class="value" id="toFlag">--:--</div>
          <div class="bar"><i id="barFlag" style="width:0%"></i></div>
        </div>

        <div class="kpi">
          <div class="label">剩餘點擊</div>
          <div class="value" id="clicksLeft">-- / --</div>
          <div class="hint" id="clicksHint">點擊頁面會彈出線索；超過上限將關閉</div>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="resetBtn">重置挑戰（清 Cookie）</button>
      </div>

      <div class="hint">伺服器端會驗證時間與點擊次數；直接改 LocalStorage 沒用。</div>
    </div>
  </div>

  <!-- 特殊頁面（線索） -->
  <div class="modal" id="modal">
    <div class="card">
      <h3>特殊頁面（線索）</h3>
      <p>觀察網路請求：<code>/api/start</code>、<code>/api/click</code>、<code>/api/flag</code>。</p>
      <div class="code" id="snippet">
fetch('/api/flag', {
  method: 'POST',
  credentials: 'include',
  headers: { 'x-debug-mode': '1', 'x-debug-now': String(Math.floor(Date.now()/1000)+4000) }
}).then(r=>r.text()).then(console.log);
      </div>
      <div class="row" style="margin-top:.5rem">
        <button class="btn copy" id="copyBtn">複製 Console 指令</button>
        <button class="btn" id="closeModal">知道了</button>
      </div>
      <div class="hint">提示：帶 <code>credentials:'include'</code> 才會附上 session；以伺服器時間為準。</div>
    </div>
  </div>

  <!-- 關閉畫面 -->
  <div class="closed" id="closed">
    <div class="box">
      <h2>Web 已自動關閉</h2>
      <p class="hint">原因：超過自動關閉時間或點擊次數上限（以伺服器端為準）。</p>
      <div style="margin-top:1rem;">
        <button class="btn" id="resetBtn2">重置挑戰</button>
      </div>
      <div class="hint" style="margin-top:.5rem;">你也可以研究網路請求，尋找不只等待的做法。</div>
    </div>
  </div>

  <!-- 旗幟畫面 -->
  <div class="flagwrap" id="flagwrap">
    <div class="flagcard">
      <h2>恭喜你，耐心通關！</h2>
      <p>以下為伺服器核發的旗幟：</p>
      <p><code id="flagText">loading…</code></p>
      <div class="row"><button class="btn" onclick="location.reload()">重新開始</button></div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const now = () => Math.floor(Date.now()/1000);
    const pad = n => String(n).padStart(2,'0');
    const fmtHMS = s => { s=Math.max(0,Math.floor(s)); return `${pad(s/3600|0)}:${pad((s%3600)/60|0)}:${pad(s%60)}`; }
    const fmtMS  = s => { s=Math.max(0,Math.floor(s)); return `${pad(s/60|0)}:${pad(s%60)}`; }
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

    let startAt=null, clicks=0, MAX_CLICKS=3, FLAG_READY_SECS=3600, AUTO_CLOSE_SECS=1800, closed=false;

    async function api(path, init) {
      const res = await fetch(path, { ...init, credentials:'include', cache:'no-store' });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    const modal = $('#modal');
    const bigbtn = $('#bigbtn');

    function showModal(){ modal.classList.add('show'); }
    function hideModal(){ modal.classList.remove('show'); }

    // 複製指令
    $('#copyBtn').onclick = async () => {
      const txt = $('#snippet').innerText.trim();
      try { await navigator.clipboard.writeText(txt); $('#copyBtn').classList.add('ok'); $('#copyBtn').textContent='已複製！'; setTimeout(()=>{ $('#copyBtn').classList.remove('ok'); $('#copyBtn').textContent='複製 Console 指令'; },1200);} catch {}
    };

    // Esc 關閉模態
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideModal(); });

    async function boot(){
      const info = await api('/api/start', { method:'POST' });
      ({ startAt, clicks, FLAG_READY_SECS, AUTO_CLOSE_SECS, MAX_CLICKS } = info);

      // 點整頁即：+1 點擊 並 顯示線索
      bigbtn.addEventListener('click', async ()=>{
        if (closed) return;
        try{
          const r = await api('/api/click', { method:'POST' });
          clicks = r.clicks;
          showModal();
        }catch(e){ /* ignore */ }
      });

      $('#closeModal').onclick = (e)=>{ e.stopPropagation(); hideModal(); };
      modal.addEventListener('click', (e)=>{ if (e.target === modal) hideModal(); });

      const doReset = async ()=>{
        if (!confirm('確定要重置挑戰並清除 Cookie 嗎？')) return;
        await api('/api/start', { method:'POST' });
        location.reload();
      };
      $('#resetBtn').onclick = doReset;
      $('#resetBtn2').onclick = doReset;

      setInterval(tick, 200);
      tick();
    }

    function setBar(el, pct){ el.style.width = clamp(pct,0,100) + '%'; }

    async function tick(){
      if (!startAt) return;
      const elapsed = now() - startAt;
      const leftClose = AUTO_CLOSE_SECS - elapsed;
      const leftFlag  = FLAG_READY_SECS - elapsed;

      $('#elapsed').textContent = fmtHMS(elapsed);
      $('#toClose').textContent = fmtMS(leftClose);
      $('#toFlag').textContent  = fmtMS(leftFlag);

      setBar($('#barClose'), AUTO_CLOSE_SECS>0 ? (elapsed / AUTO_CLOSE_SECS)*100 : 0);
      setBar($('#barFlag'),  (elapsed / FLAG_READY_SECS)*100);

      const left = Math.max(0, MAX_CLICKS - clicks);
      $('#clicksLeft').textContent = `${left} / ${MAX_CLICKS}`;
      $('#clicksLeft').classList.toggle('danger', left===0);
      $('#clicksHint').textContent = left===0 ? '已達上限，請勿再點' : '點擊頁面會彈出線索；超過上限將關閉';

      if (AUTO_CLOSE_SECS>0 && elapsed >= AUTO_CLOSE_SECS || clicks > MAX_CLICKS) {
        closed = true; $('#closed').classList.add('show'); return;
      }
      if (elapsed >= FLAG_READY_SECS) {
        try{
          const r = await fetch('/api/flag', { method:'POST', credentials:'include' });
        if (r.ok) {
            const j = await r.json();
            $('#flagText').textContent = j.flag || '(flag 失敗)';
            $('#flagwrap').classList.add('show');
          }
        }catch(e){}
      }
    }

    boot().catch(err => alert('初始化失敗：'+err.message));
  </script>
</body>
</html>

