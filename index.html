<!--
CTF WaitRoom Challenge â€“ å–®æª”å‰ç«¯åŸå‹ + Node/Express å¾Œç«¯ï¼ˆè¦‹æ–‡æœ« server.jsï¼‰
ç›®æ¨™ï¼š
1) åœ¨é é¢åœç•™æ»¿ 1 å°æ™‚è‡ªå‹•é¡¯ç¤º flagã€‚
2) åœç•™è¶…é 30 åˆ†é˜ æˆ– é»æ“Šè¶…é 3 æ¬¡ â†’ è¦–ç‚ºã€Œè‡ªå‹•é—œé–‰ã€ã€‚
3) ä»»æ„é»æ“Šéƒ½æœƒè·³å‡ºã€Œç‰¹æ®Šé é¢ï¼ˆç·šç´¢ï¼‰ã€ã€‚
4) DevTools å¯æ‰¾åˆ°ç­‰å¾…æ§åˆ¶çš„é‚è¼¯ï¼›ä¹Ÿèƒ½åœ¨æª”æ¡ˆç³»çµ±ç›´æ¥æ‰¾åˆ° flag.txtã€‚

ç”¨æ³•ï¼š
1) å°‡æœ¬æª”æ¡ˆå­˜ç‚º public/index.htmlã€‚
2) å¦è¦‹æ–‡æœ« server.js å…§å®¹ï¼Œå­˜ç‚º server.jsï¼›åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œï¼š
   npm i express
   node server.js
3) ç€è¦½ http://localhost:8080/
-->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WaitRoom â€“ åœç•™ä¸€å°æ™‚æ‹¿æ——</title>
  <style>
    :root{
      --bg:#0f1115; --fg:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,EmojiSymbols}
    .wrap{position:fixed;inset:0;display:grid;place-items:center}
    .bigbtn{
      position:absolute;inset:0;border:none;background:transparent;cursor:pointer;
    }
    .panel{
      z-index:1;display:flex;flex-direction:column;gap:.75rem;align-items:center;text-align:center;padding:2rem;max-width:720px
    }
    .title{font-size:clamp(28px,4vw,40px);font-weight:800;letter-spacing:.5px}
    .kpis{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center}
    .kpi{padding:1rem 1.25rem;border:1px solid #1f2937;border-radius:16px;background:#0b0d12}
    .kpi .v{font-variant-tabular-nums:tabular-nums;font-size:1.25rem}
    .sub{color:var(--muted);font-size:.9rem}
    .hint{font-size:.95rem;color:#a7f3d0}
    .foot{color:var(--muted);font-size:.85rem}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;border:1px dashed #334155;color:#94a3b8}

    /* ç‰¹æ®Šé é¢ï¼ˆæ¨¡æ…‹ï¼‰ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:1rem}
    .modal.show{display:flex}
    .card{background:#0b0d12;border:1px solid #1f2937;border-radius:18px;max-width:560px;width:100%;padding:1.25rem}
    .card h3{margin:.25rem 0 0.5rem 0;font-size:1.15rem}
    .card p{color:#d1d5db;line-height:1.6}
    .row{display:flex;gap:.75rem;flex-wrap:wrap;margin-top:1rem}
    .btn{padding:.6rem 1rem;border-radius:12px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;cursor:pointer}
    .btn:active{transform:translateY(1px)}

    /* é—œé–‰ç•«é¢ */
    .closed{position:fixed;inset:0;display:grid;place-items:center;background:#0a0c10}
    .closed .box{border:1px dashed #374151;border-radius:18px;padding:2rem;max-width:560px;text-align:center}
    .closed h2{margin:0 0 .5rem 0}

    /* flag ç•«é¢ */
    .flagwrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.72);}
    .flagwrap.show{display:flex}
    .flagcard{background:#001b1b;border:1px solid #0e7490;border-radius:20px;padding:1.5rem;max-width:680px;width:100%}
    .flagcard h2{margin-top:0}
    code{background:#111827;border:1px solid #1f2937;padding:.25rem .4rem;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <button class="bigbtn" id="bigbtn" aria-label="ç­‰å¾…å³å¯ç²å¾—æ——å¹Ÿ"></button>
    <div class="panel">
      <div class="title">ç­‰å¾…ä¸€å°æ™‚ï¼Œç²å¾—æ——å¹Ÿ ğŸ³ï¸</div>
      <div class="kpis">
        <div class="kpi"><div class="sub">å·²ç­‰å¾…</div><div class="v" id="elapsed">00:00:00</div></div>
        <div class="kpi"><div class="sub">è·é›¢è‡ªå‹•é—œé–‰ï¼ˆ30 åˆ†ï¼‰</div><div class="v" id="toClose">30:00</div></div>
        <div class="kpi"><div class="sub">è·é›¢å¯é ˜æ——ï¼ˆ60 åˆ†ï¼‰</div><div class="v" id="toFlag">60:00</div></div>
        <div class="kpi"><div class="sub">é»æ“Šæ¬¡æ•¸ï¼ˆâ‰¤3ï¼‰</div><div class="v" id="clicks">0</div></div>
      </div>
      <div class="hint">æç¤ºï¼šä»»æ„é»æ“Šéƒ½æœƒè·³å‡ºã€Œç‰¹æ®Šé é¢ã€ã€‚ä½†é»å¤ªå¤šæœƒé—œé–€å–”ã€‚</div>
      <div class="foot">ä½ å¯ä»¥å¾ <span class="pill">é–‹ç™¼äººå“¡å·¥å…·</span> è§€å¯Ÿç­‰å¾…é‚è¼¯ï¼›æˆ–ç›´æ¥æª”æ¡ˆç³»çµ±æ‰¾ <code>/flag.txt</code>ã€‚</div>
    </div>
  </div>

  <!-- ç‰¹æ®Šé é¢ï¼ˆç·šç´¢ï¼‰ -->
  <div class="modal" id="modal">
    <div class="card">
      <h3>ç‰¹æ®Šé é¢ï¼ˆç·šç´¢ï¼‰</h3>
      <p id="clueText">â€¦â€¦</p>
      <div class="row">
        <button class="btn" id="closeModal">çŸ¥é“äº†</button>
        <button class="btn" id="openDevtools">æ€éº¼æ‰¾é‚è¼¯ï¼Ÿ</button>
      </div>
    </div>
  </div>

  <!-- flag ç•«é¢ -->
  <div class="flagwrap" id="flagwrap">
    <div class="flagcard">
      <h2>æ­å–œä½ ï¼Œè€å¿ƒé€šé—œï¼</h2>
      <p>ä»¥ä¸‹ç‚ºä½ çš„æ——å¹Ÿï¼š</p>
      <p><code id="flagText">loadingâ€¦</code></p>
      <p class="sub">ï¼ˆåŒæ™‚ä¹Ÿå¯æ–¼ <code>/flag.txt</code> ç›´æ¥å–å¾—ã€‚ï¼‰</p>
      <div class="row"><button class="btn" onclick="location.reload()">é‡æ–°é–‹å§‹</button></div>
    </div>
  </div>

  <script>
  // === ç­‰å¾…æ§åˆ¶ï¼ˆå…¬é–‹åœ¨å…¨åŸŸï¼Œä¾› DevTools é–±è®€ï¼‰ ===
  window.__waitControls = {
    START_KEY: 'wr_start_at',
    CLICK_KEY: 'wr_clicks',
    CLOSED_KEY: 'wr_closed',
    FLAG_READY_SECS: 60 * 60,   // 1 å°æ™‚
    AUTO_CLOSE_SECS: 30 * 60,   // 30 åˆ†é˜
    MAX_CLICKS: 3
  };

  const S = window.__waitControls;

  // å·¥å…·å‡½å¼
  const $ = sel => document.querySelector(sel);
  const fmtHMS = (s)=>{
    s = Math.max(0, Math.floor(s));
    const h = String(Math.floor(s/3600)).padStart(2,'0');
    const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const sec = String(s%60).padStart(2,'0');
    return `${h}:${m}:${sec}`;
  }
  const fmtMS = (s)=>{
    s = Math.max(0, Math.floor(s));
    const m = String(Math.floor(s/60)).padStart(2,'0');
    const sec = String(s%60).padStart(2,'0');
    return `${m}:${sec}`;
  }

  // åˆå§‹åŒ–ç‹€æ…‹
  const now = ()=> Math.floor(Date.now()/1000);
  if(!localStorage.getItem(S.START_KEY)){
    localStorage.setItem(S.START_KEY, String(now()));
  }
  if(!localStorage.getItem(S.CLICK_KEY)){
    localStorage.setItem(S.CLICK_KEY, '0');
  }
  const isClosed = ()=> localStorage.getItem(S.CLOSED_KEY)==='1';
  const setClosed = ()=> {
    localStorage.setItem(S.CLOSED_KEY,'1');
    renderClosed();
  };

  function renderClosed(){
    document.body.innerHTML = `
      <div class="closed">
        <div class="box">
          <h2>Web å·²è‡ªå‹•é—œé–‰</h2>
          <p class="sub">åŸå› ï¼šè¶…é 30 åˆ†é˜æˆ–é»æ“Šè¶…é 3 æ¬¡ã€‚</p>
          <p class="sub">ä½ å¯ä»¥é‡æ•´ä¸¦æ¸…ç©º <code>LocalStorage</code> å†è©¦ä¸€æ¬¡ã€‚</p>
        </div>
      </div>`;
  }

  if(isClosed()){
    renderClosed();
  } else {
    boot();
  }

  function boot(){
    const startAt = Number(localStorage.getItem(S.START_KEY)|| now());
    const bigbtn = $('#bigbtn');
    const modal = $('#modal');
    const closeModal = $('#closeModal');
    const openDevtools = $('#openDevtools');

    let clicks = Number(localStorage.getItem(S.CLICK_KEY)||0);
    let closed = false;

    const clues = [
      'æç¤º 1ï¼šæ§åˆ¶å¸¸æ•¸å…¬é–‹åœ¨ window.__waitControlsã€‚',
      'æç¤º 2ï¼šLocalStorage ä¸­çš„ wr_start_at èˆ‡ wr_clicks å¯ä»¥è§€å¯Ÿï¼ˆèˆ‡è¢«æƒ¡æ„ç«„æ”¹ï¼‰ã€‚',
      'æç¤º 3ï¼š/flag.txt å¯èƒ½æ˜¯ä½ æƒ³æ‰¾çš„æª”æ¡ˆã€‚',
      'æç¤º 4ï¼šè¶…é 30 åˆ†é˜æˆ–é»æ»¿ 3 æ¬¡ï¼Œå°±æœƒè¢«é—œé–€ã€‚',
      'æç¤º 5ï¼šåœç•™æ»¿ 60 åˆ†é˜æœƒæ‰“é–‹æ——å¹Ÿç•«é¢ã€‚'
    ];

    function showClue(){
      const idx = Math.floor(Math.random()*clues.length);
      $('#clueText').textContent = clues[idx];
      modal.classList.add('show');
    }

    function updateKPI(){
      const t = now();
      const el = t - startAt;
      const toClose = S.AUTO_CLOSE_SECS - el;
      const toFlag = S.FLAG_READY_SECS - el;
      $('#elapsed').textContent = fmtHMS(el);
      $('#toClose').textContent = fmtMS(toClose);
      $('#toFlag').textContent = fmtMS(toFlag);
      $('#clicks').textContent = String(clicks);

      if(el >= S.AUTO_CLOSE_SECS || clicks > S.MAX_CLICKS){
        closed = true; setClosed();
        return;
      }
      if(el >= S.FLAG_READY_SECS){
        revealFlag();
      }
    }

    const ticker = setInterval(updateKPI, 1000);
    updateKPI();

    // ä»»æ„é»æ“Š â†’ å½ˆå‡ºç‰¹æ®Šé é¢ï¼›>3 æ¬¡è¦–ç‚ºé—œé–‰
    function onAnyClick(e){
      if(closed) return;
      clicks++;
      localStorage.setItem(S.CLICK_KEY, String(clicks));
      showClue();
      if(clicks > S.MAX_CLICKS){
        setClosed();
      }
    }
    document.addEventListener('click', onAnyClick);

    closeModal.addEventListener('click', ()=> modal.classList.remove('show'));
    openDevtools.addEventListener('click', ()=> {
      modal.classList.remove('show');
      console.log('%cè§€å¯Ÿé€™å€‹ç‰©ä»¶ â†’ window.__waitControls', 'color:#22d3ee');
      console.log(window.__waitControls);
    });

    // DevTools æª¢æ¸¬ï¼ˆå¼±ï¼‰ï¼šè¦–çª—å¤–æ¡†èˆ‡å…§æ¡†å°ºå¯¸å·®
    setInterval(()=>{
      const dw = window.outerWidth - window.innerWidth;
      const dh = window.outerHeight - window.innerHeight;
      if(dw > 160 || dh > 160){
        // åœ¨é€™è£¡ä¸åšè™•ç½°ï¼Œç´”æç¤ºï¼š
        console.log('[info] ä¼¼ä¹é–‹äº†é–‹ç™¼è€…å·¥å…·æˆ–è¦–çª—è¢«èª¿æ•´ã€‚');
      }
    }, 2000);
  }

  async function revealFlag(){
    const fw = document.getElementById('flagwrap');
    const flagText = document.getElementById('flagText');
    if(fw.classList.contains('show')) return; // å·²é¡¯ç¤ºé
    try{
      const res = await fetch('/flag.txt',{cache:'no-store'});
      const txt = (await res.text()).trim();
      flagText.textContent = txt || '(flag è¼‰å…¥å¤±æ•—)';
    }catch(err){
      flagText.textContent = '(flag è¼‰å…¥å¤±æ•—)';
    }
    fw.classList.add('show');
  }

  // å¦ä¸€è·¯ç·šï¼šæŠŠä¸€ä»½å‡ flag æ··åœ¨åŸå§‹ç¢¼è¨»è§£ï¼Œé¿å…èª¤å°ï¼ˆCTF å¯è‡ªè¨‚ï¼‰
  /* base64: RkxBR3s2MHNfczBfTE9OR30= â†’ è§£ç¢¼ç‚º FLAG{60s_s0_LONG}ï¼ˆå‡ï¼‰ */
  </script>
</body>
</html>

<!-- ====================== ä»¥ä¸‹ç‚º Node/Express ç°¡æ˜“å¾Œç«¯ =====================
å°‡ä»¥ä¸‹å…§å®¹å¦å­˜ç‚º server.jsï¼Œèˆ‡ public/ åŒå±¤ã€‚
------------------------------------------------------------------------------
const express = require('express');
const path = require('path');
const app = express();

// éœæ…‹æª”æ¡ˆï¼ˆindex.htmlã€CSS/JSã€flag.txtï¼‰
app.use(express.static(path.join(__dirname, 'public'), {
  etag: false,
  lastModified: false,
  cacheControl: false,
  setHeaders: (res, filePath) => {
    // é¿å…ç€è¦½å™¨æŠŠ flag.txt å¿«å–ä½
    if (filePath.endsWith('flag.txt')) {
      res.set('Cache-Control', 'no-store');
    }
  }
}));

// å¯é¸çš„ /closed é¡¯ç¤ºï¼ˆå¦‚æœæƒ³ç”¨ 302 å°è½‰æ¨¡æ“¬é—œé–‰ï¼Œå¯ç”¨æ­¤é ï¼‰ï¼š
app.get('/closed', (req, res) => {
  res.send(`<!doctype html><meta charset="utf-8"/><title>Closed</title>
  <style>body{margin:0;display:grid;place-items:center;height:100vh;background:#0a0c10;color:#e5e7eb;font-family:system-ui}</style>
  <div><h2>Web å·²é—œé–‰</h2><p>è«‹ç¨å¾Œå†ä¾†</p></div>`);
});

const PORT = process.env.PORT || 8080;
app.listen(PORT, () => console.log(`WaitRoom on http://localhost:${PORT}`));
------------------------------------------------------------------------------

åœ¨ public/ ç›®éŒ„æ”¾å…¥ï¼š
- index.htmlï¼ˆæœ¬æª”ï¼‰
- flag.txtï¼ˆä¾‹å¦‚ï¼šFLAG{patient_is_power}}

æ”»é˜²èˆ‡è§£æ³•èªªæ˜ï¼ˆäº¤çµ¦é¸æ‰‹çš„ç·šç´¢ä¸ä¸€å®šå…¨çµ¦ï¼Œä¾å‡ºé¡Œèª¿æ•´ï¼‰ï¼š
- æƒ…æ³ä¸€ï¼ˆDevToolsï¼‰ï¼šè§€å¯Ÿ window.__waitControls èˆ‡ localStorageï¼ˆwr_start_atã€wr_clicksï¼‰ï¼Œè®€æ‡‚è§¸ç™¼æ¢ä»¶ã€‚
- æƒ…æ³äºŒï¼ˆæª”æ¡ˆï¼‰ï¼šç›´æ¥å» /flag.txt å–æª”ï¼›æˆ–æŠ“ç«™æª”å£“ç¸®æ‰¾ã€‚ä½ ä¹Ÿå¯åŠ  robots.txt/ç‰¹æ®Šè·¯å¾‘æ··æ·†ã€‚
- è‡ªå‹•é—œé–‰å¯¦ä½œï¼šæœ¬é ä»¥æ›¿æ› DOM æ¨¡æ“¬ï¼ˆç€è¦½å™¨é™åˆ¶ï¼Œç„¡æ³•å¼·åˆ¶ window.closeï¼‰ã€‚äº¦å¯å°å‘ /closedã€‚
- è®Šé«”ï¼šæŠŠ FLAG_READY_SECS/AUTO_CLOSE_SECS/ MAX_CLICKS æ”¹ç‚ºæ›´åˆé‘½ï¼›æˆ–æŠŠ flag API æ›åˆ° /api/flagï¼Œåš Referer/æ™‚é–“æˆ³æª¢æŸ¥ã€‚
- åä½œå¼Šï¼šå¯åœ¨å¾Œç«¯ç¶ session + ç°½å tokenï¼Œé¿å…ç›´æ¥æ”¹ localStorageï¼›æœ¬é¡Œåˆ»æ„ç•™æ´ï¼Œç¬¦åˆæ•™å­¸ç›®çš„ã€‚

-->
