<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WaitRoom</title>
  <style>
    :root{--bg:#0f1115;--panel:#0b0d12;--border:#1f2937;--fg:#e5e7eb;--muted:#9ca3af;--accent:#60a5fa;--danger:#ef4444;--ok:#22c55e}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto}
    .wrap{position:fixed;inset:0;display:grid;place-items:center}
    .bigbtn{position:absolute;inset:0;border:none;background:transparent;cursor:pointer}
    .panel{z-index:1;display:flex;flex-direction:column;gap:1rem;align-items:center;text-align:center;padding:2rem;max-width:920px;width:100%}
    .title{font-size:clamp(28px,4vw,44px);font-weight:800;letter-spacing:.02em}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:1rem;width:100%}
    @media (max-width:820px){.kpis{grid-template-columns:repeat(2,minmax(160px,1fr))}}
    .kpi{padding:1rem 1.25rem;border:1px solid var(--border);border-radius:16px;background:var(--panel)}
    .kpi .label{color:var(--muted);font-size:.9rem;margin-bottom:.25rem}
    .kpi .value{font-variant-numeric:tabular-nums;letter-spacing:.02em;font-size:1.35rem}
    .bar{margin-top:.5rem;height:6px;background:#0a0c10;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#34d399)}
    .bar.danger>i{background:linear-gradient(90deg,var(--danger),#f59e0b)}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center}
    .btn{padding:.6rem 1rem;border-radius:12px;border:1px solid var(--border);background:#0f172a;color:#e2e8f0;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.copy.ok{border-color:#14532d;background:#14532d}
    .hint{color:var(--muted);font-size:.9rem}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:1rem}
    .modal.show{display:flex}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;max-width:680px;width:100%;padding:1.25rem}
    .card h3{margin:.2rem 0 0.5rem 0}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b1220;border:1px solid var(--border);padding:.75rem;border-radius:10px;overflow:auto;font-size:.9rem;text-align:left}
    .code kbd{background:#111827;border:1px solid var(--border);padding:.08rem .35rem;border-radius:6px}

    .closed{position:fixed;inset:0;display:none;place-items:center;background:#0a0c10}
    .closed.show{display:grid}
    .closed .box{border:1px dashed var(--border);border-radius:18px;padding:2rem;max-width:620px;text-align:center;background:var(--panel)}

    .flagwrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.72)}
    .flagwrap.show{display:flex}
    .flagcard{background:#001b1b;border:1px solid #0e7490;border-radius:20px;padding:1.5rem;max-width:680px;width:100%}
    code{background:#111827;border:1px solid var(--border);padding:.25rem .4rem;border-radius:6px}
    .danger{color:var(--danger)}
    .ok{color:var(--ok)}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <!-- åªå°é€™å€‹ã€Œæ•´é å¤§æŒ‰éˆ•ã€è¨ˆæ¬¡ -->
    <button class="bigbtn" id="bigbtn" aria-label="ç­‰å¾…å³å¯ç²å¾—æ——å¹Ÿ"></button>

    <div class="panel">
      <div class="title">ç­‰å¾…ä¸€å°æ™‚ï¼Œä¼ºæœå™¨é©—è­‰ ğŸ³ï¸</div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">å·²ç­‰å¾…</div>
          <div class="value" id="elapsed">--:--:--</div>
        </div>

        <div class="kpi">
          <div class="label">è·é›¢è‡ªå‹•é—œé–‰</div>
          <div class="value" id="toClose">--:--</div>
          <div class="bar danger"><i id="barClose" style="width:0%"></i></div>
        </div>

        <div class="kpi">
          <div class="label">è·é›¢å¯é ˜æ——</div>
          <div class="value" id="toFlag">--:--</div>
          <div class="bar"><i id="barFlag" style="width:0%"></i></div>
        </div>

        <div class="kpi">
          <div class="label">å‰©é¤˜é»æ“Š</div>
          <div class="value" id="clicksLeft">-- / --</div>
          <div class="hint" id="clicksHint">é»æ“Šé é¢æœƒå½ˆå‡ºç·šç´¢ï¼›è¶…éä¸Šé™å°‡é—œé–‰</div>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="resetBtn">é‡ç½®æŒ‘æˆ°ï¼ˆæ¸… Cookieï¼‰</button>
      </div>

      <div class="hint">ä¼ºæœå™¨ç«¯æœƒé©—è­‰æ™‚é–“èˆ‡é»æ“Šæ¬¡æ•¸ï¼›ç›´æ¥æ”¹ LocalStorage æ²’ç”¨ã€‚</div>
    </div>
  </div>

  <!-- ç‰¹æ®Šé é¢ï¼ˆç·šç´¢ï¼‰ -->
  <div class="modal" id="modal">
    <div class="card">
      <h3>ç‰¹æ®Šé é¢ï¼ˆç·šç´¢ï¼‰</h3>
      <p>è§€å¯Ÿç¶²è·¯è«‹æ±‚ï¼š<code>/api/start</code>ã€<code>/api/click</code>ã€<code>/api/flag</code>ã€‚</p>
      <div class="code" id="snippet">
fetch('/api/flag', {
  method: 'POST',
  credentials: 'include',
  headers: { 'x-debug-mode': '1', 'x-debug-now': String(Math.floor(Date.now()/1000)+4000) }
}).then(r=>r.text()).then(console.log);
      </div>
      <div class="row" style="margin-top:.5rem">
        <button class="btn copy" id="copyBtn">è¤‡è£½ Console æŒ‡ä»¤</button>
        <button class="btn" id="closeModal">çŸ¥é“äº†</button>
      </div>
      <div class="hint">æç¤ºï¼šå¸¶ <code>credentials:'include'</code> æ‰æœƒé™„ä¸Š sessionï¼›ä»¥ä¼ºæœå™¨æ™‚é–“ç‚ºæº–ã€‚</div>
    </div>
  </div>

  <!-- é—œé–‰ç•«é¢ -->
  <div class="closed" id="closed">
    <div class="box">
      <h2>Web å·²è‡ªå‹•é—œé–‰</h2>
      <p class="hint">åŸå› ï¼šè¶…éè‡ªå‹•é—œé–‰æ™‚é–“æˆ–é»æ“Šæ¬¡æ•¸ä¸Šé™ï¼ˆä»¥ä¼ºæœå™¨ç«¯ç‚ºæº–ï¼‰ã€‚</p>
      <div style="margin-top:1rem;">
        <button class="btn" id="resetBtn2">é‡ç½®æŒ‘æˆ°</button>
      </div>
      <div class="hint" style="margin-top:.5rem;">ä½ ä¹Ÿå¯ä»¥ç ”ç©¶ç¶²è·¯è«‹æ±‚ï¼Œå°‹æ‰¾ä¸åªç­‰å¾…çš„åšæ³•ã€‚</div>
    </div>
  </div>

  <!-- æ——å¹Ÿç•«é¢ -->
  <div class="flagwrap" id="flagwrap">
    <div class="flagcard">
      <h2>æ­å–œä½ ï¼Œè€å¿ƒé€šé—œï¼</h2>
      <p>ä»¥ä¸‹ç‚ºä¼ºæœå™¨æ ¸ç™¼çš„æ——å¹Ÿï¼š</p>
      <p><code id="flagText">loadingâ€¦</code></p>
      <div class="row"><button class="btn" onclick="location.reload()">é‡æ–°é–‹å§‹</button></div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const now = () => Math.floor(Date.now()/1000);
    const pad = n => String(n).padStart(2,'0');
    const fmtHMS = s => { s=Math.max(0,Math.floor(s)); return `${pad(s/3600|0)}:${pad((s%3600)/60|0)}:${pad(s%60)}`; }
    const fmtMS  = s => { s=Math.max(0,Math.floor(s)); return `${pad(s/60|0)}:${pad(s%60)}`; }
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

    let startAt=null, clicks=0, MAX_CLICKS=3, FLAG_READY_SECS=3600, AUTO_CLOSE_SECS=1800, closed=false;

    async function api(path, init) {
      const res = await fetch(path, { ...init, credentials:'include', cache:'no-store' });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    const modal = $('#modal');
    const bigbtn = $('#bigbtn');

    function showModal(){ modal.classList.add('show'); }
    function hideModal(){ modal.classList.remove('show'); }

    // è¤‡è£½æŒ‡ä»¤
    $('#copyBtn').onclick = async () => {
      const txt = $('#snippet').innerText.trim();
      try { await navigator.clipboard.writeText(txt); $('#copyBtn').classList.add('ok'); $('#copyBtn').textContent='å·²è¤‡è£½ï¼'; setTimeout(()=>{ $('#copyBtn').classList.remove('ok'); $('#copyBtn').textContent='è¤‡è£½ Console æŒ‡ä»¤'; },1200);} catch {}
    };

    // Esc é—œé–‰æ¨¡æ…‹
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideModal(); });

    async function boot(){
      const info = await api('/api/start', { method:'POST' });
      ({ startAt, clicks, FLAG_READY_SECS, AUTO_CLOSE_SECS, MAX_CLICKS } = info);

      // é»æ•´é å³ï¼š+1 é»æ“Š ä¸¦ é¡¯ç¤ºç·šç´¢
      bigbtn.addEventListener('click', async ()=>{
        if (closed) return;
        try{
          const r = await api('/api/click', { method:'POST' });
          clicks = r.clicks;
          showModal();
        }catch(e){ /* ignore */ }
      });

      $('#closeModal').onclick = (e)=>{ e.stopPropagation(); hideModal(); };
      modal.addEventListener('click', (e)=>{ if (e.target === modal) hideModal(); });

      const doReset = async ()=>{
        if (!confirm('ç¢ºå®šè¦é‡ç½®æŒ‘æˆ°ä¸¦æ¸…é™¤ Cookie å—ï¼Ÿ')) return;
        await api('/api/start', { method:'POST' });
        location.reload();
      };
      $('#resetBtn').onclick = doReset;
      $('#resetBtn2').onclick = doReset;

      setInterval(tick, 200);
      tick();
    }

    function setBar(el, pct){ el.style.width = clamp(pct,0,100) + '%'; }

    async function tick(){
      if (!startAt) return;
      const elapsed = now() - startAt;
      const leftClose = AUTO_CLOSE_SECS - elapsed;
      const leftFlag  = FLAG_READY_SECS - elapsed;

      $('#elapsed').textContent = fmtHMS(elapsed);
      $('#toClose').textContent = fmtMS(leftClose);
      $('#toFlag').textContent  = fmtMS(leftFlag);

      setBar($('#barClose'), AUTO_CLOSE_SECS>0 ? (elapsed / AUTO_CLOSE_SECS)*100 : 0);
      setBar($('#barFlag'),  (elapsed / FLAG_READY_SECS)*100);

      const left = Math.max(0, MAX_CLICKS - clicks);
      $('#clicksLeft').textContent = `${left} / ${MAX_CLICKS}`;
      $('#clicksLeft').classList.toggle('danger', left===0);
      $('#clicksHint').textContent = left===0 ? 'å·²é”ä¸Šé™ï¼Œè«‹å‹¿å†é»' : 'é»æ“Šé é¢æœƒå½ˆå‡ºç·šç´¢ï¼›è¶…éä¸Šé™å°‡é—œé–‰';

      if (AUTO_CLOSE_SECS>0 && elapsed >= AUTO_CLOSE_SECS || clicks > MAX_CLICKS) {
        closed = true; $('#closed').classList.add('show'); return;
      }
      if (elapsed >= FLAG_READY_SECS) {
        try{
          const r = await fetch('/api/flag', { method:'POST', credentials:'include' });
        if (r.ok) {
            const j = await r.json();
            $('#flagText').textContent = j.flag || '(flag å¤±æ•—)';
            $('#flagwrap').classList.add('show');
          }
        }catch(e){}
      }
    }

    boot().catch(err => alert('åˆå§‹åŒ–å¤±æ•—ï¼š'+err.message));
  </script>
</body>
</html>

