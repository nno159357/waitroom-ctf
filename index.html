<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WaitRoom â€“ ä¼ºæœå™¨é©—è­‰ç‰ˆ</title>
  <style>
    :root{--bg:#0f1115;--fg:#e5e7eb;--muted:#9ca3af}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto}
    .wrap{position:fixed;inset:0;display:grid;place-items:center}
    .bigbtn{position:absolute;inset:0;border:none;background:transparent;cursor:pointer}
    .panel{z-index:1;display:flex;flex-direction:column;gap:.75rem;align-items:center;text-align:center;padding:2rem;max-width:720px}
    .title{font-size:clamp(28px,4vw,40px);font-weight:800}
    .kpis{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center}
    .kpi{padding:1rem 1.25rem;border:1px solid #1f2937;border-radius:16px;background:#0b0d12}
    .kpi .v{font-variant-numeric:tabular-nums;font-size:1.25rem}
    .sub{color:var(--muted);font-size:.9rem}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center}
    .btn{padding:.6rem 1rem;border-radius:12px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:1rem}
    .modal.show{display:flex}
    .card{background:#0b0d12;border:1px solid #1f2937;border-radius:18px;max-width:560px;width:100%;padding:1.25rem}
    .closed{position:fixed;inset:0;display:grid;place-items:center;background:#0a0c10}
    .closed .box{border:1px dashed #374151;border-radius:18px;padding:2rem;max-width:560px;text-align:center}
    .flagwrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.72)}
    .flagwrap.show{display:flex}
    .flagcard{background:#001b1b;border:1px solid #0e7490;border-radius:20px;padding:1.5rem;max-width:680px;width:100%}
    code{background:#111827;border:1px solid #1f2937;padding:.25rem .4rem;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <button class="bigbtn" id="bigbtn" aria-label="ç­‰å¾…å³å¯ç²å¾—æ——å¹Ÿ"></button>
    <div class="panel">
      <div class="title">ç­‰å¾…ä¸€å°æ™‚ï¼Œä¼ºæœå™¨é©—è­‰ ğŸ³ï¸</div>
      <div class="kpis">
        <div class="kpi"><div class="sub">å·²ç­‰å¾…</div><div class="v" id="elapsed">--:--:--</div></div>
        <div class="kpi"><div class="sub">è·é›¢è‡ªå‹•é—œé–‰</div><div class="v" id="toClose">--:--</div></div>
        <div class="kpi"><div class="sub">è·é›¢å¯é ˜æ——</div><div class="v" id="toFlag">--:--</div></div>
        <div class="kpi"><div class="sub">é»æ“Šæ¬¡æ•¸ï¼ˆâ‰¤3ï¼‰</div><div class="v" id="clicks">0</div></div>
      </div>

      <div class="row">
        <button class="btn" id="resetBtn">é‡ç½®æŒ‘æˆ°ï¼ˆæ¸… Cookieï¼‰</button>
      </div>

      <div class="sub">ä¼ºæœå™¨ç«¯æœƒé©—è­‰æ™‚é–“èˆ‡é»æ“Šæ¬¡æ•¸ï¼›ç›´æ¥æ”¹ localStorage æ²’ç”¨ã€‚</div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="card">
      <h3>ç‰¹æ®Šé é¢ï¼ˆç·šç´¢ï¼‰</h3>
      <p id="clueText">è§€å¯Ÿç¶²è·¯è«‹æ±‚ï¼š/api/startã€/api/clickã€/api/flag</p>
      <div class="row">
        <button class="btn" id="closeModal">çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <div class="closed" id="closed" style="display:none">
    <div class="box">
      <h2>Web å·²è‡ªå‹•é—œé–‰</h2>
      <p class="sub">åŸå› ï¼šè¶…é 30 åˆ†é˜æˆ–é»æ“Šè¶…é 3 æ¬¡ï¼ˆä»¥ä¼ºæœå™¨ç«¯ç‚ºæº–ï¼‰ã€‚</p>
      <div style="margin-top:1rem;">
        <button class="btn" id="resetBtn2">é‡ç½®æŒ‘æˆ°</button>
      </div>
    </div>
  </div>

  <div class="flagwrap" id="flagwrap">
    <div class="flagcard">
      <h2>æ­å–œä½ ï¼Œè€å¿ƒé€šé—œï¼</h2>
      <p>ä»¥ä¸‹ç‚ºä¼ºæœå™¨æ ¸ç™¼çš„æ——å¹Ÿï¼š</p>
      <p><code id="flagText">loadingâ€¦</code></p>
      <div class="row"><button class="btn" onclick="location.reload()">é‡æ–°é–‹å§‹</button></div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const now = () => Math.floor(Date.now()/1000);
    const pad = n => String(n).padStart(2,'0');
    const fmtHMS = s => { s=Math.max(0,Math.floor(s)); return `${pad(s/3600|0)}:${pad((s%3600)/60|0)}:${pad(s%60)}`; }
    const fmtMS  = s => { s=Math.max(0,Math.floor(s)); return `${pad(s/60|0)}:${pad(s%60)}`; }

    let startAt = null, clicks = 0, FLAG_READY_SECS=3600, AUTO_CLOSE_SECS=1800, MAX_CLICKS=3, closed=false;

    async function api(path, init) {
      const res = await fetch(path, { ...init, credentials: 'include', cache:'no-store' });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function boot(){
      // åˆå§‹åŒ–ï¼ˆä¼ºæœå™¨å›å‚³é–‹å§‹æ™‚é–“/è¦å‰‡ï¼‰
      const info = await api('/api/start', { method:'POST' });
      startAt = info.startAt;
      clicks  = info.clicks;
      FLAG_READY_SECS = info.FLAG_READY_SECS;
      AUTO_CLOSE_SECS = info.AUTO_CLOSE_SECS;
      MAX_CLICKS      = info.MAX_CLICKS;
      tick();

      // é»æ“Šï¼šä¼ºæœå™¨ç«¯ç´¯åŠ ï¼Œå›å‚³æœ€æ–° clicks
      document.addEventListener('click', async () => {
        if (closed) return;
        try{
          const r = await api('/api/click', { method:'POST' });
          clicks = r.clicks;
          $('#clicks').textContent = clicks;
          $('#modal').classList.add('show');
          if (clicks > MAX_CLICKS) {
            closed = true; $('#closed').style.display='grid';
          }
        }catch(e){ console.warn(e.message); }
      });

      $('#closeModal').onclick = ()=> $('#modal').classList.remove('show');
      $('#resetBtn').onclick = $('#resetBtn2').onclick = async ()=>{
        await api('/api/start', { method:'POST' }); // é‡ç½® cookie
        location.reload();
      };

      // æ¯ç§’æ›´æ–° UIï¼›æ™‚é–“åˆ°å‘¼å« /api/flag ç”±ä¼ºæœå™¨åˆ¤å®š
      setInterval(tick, 1000);
    }

    async function tick(){
      if (!startAt) return;
      const el = now() - startAt;
      $('#elapsed').textContent = fmtHMS(el);
      $('#toClose').textContent = fmtMS(AUTO_CLOSE_SECS - el);
      $('#toFlag').textContent  = fmtMS(FLAG_READY_SECS - el);
      $('#clicks').textContent  = clicks;

      if (el >= AUTO_CLOSE_SECS || clicks > MAX_CLICKS) {
        closed = true; $('#closed').style.display='grid'; return;
      }
      if (el >= FLAG_READY_SECS) {
        try{
          const r = await api('/api/flag', { method:'POST' });
          $('#flagText').textContent = r.flag || '(flag å¤±æ•—)';
          $('#flagwrap').classList.add('show');
        }catch(e){
          // é‚„ä¸çµ¦ï¼ˆä¼ºæœå™¨æœƒå›éŒ¯èª¤è¨Šæ¯ï¼‰ï¼Œå¿½ç•¥
        }
      }
    }

    boot().catch(err => alert('åˆå§‹åŒ–å¤±æ•—ï¼š'+err.message));
  </script>
</body>
</html>
